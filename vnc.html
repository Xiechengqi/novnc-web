<!-- index.vnc - default html page for HTML VNC client.  On any file ending in
     .vnc, the HTTP server embedded in Xvnc will substitute the following
     variables when preceded by a dollar: USER, DESKTOP, DISPLAY, APPLETWIDTH,
     APPLETHEIGHT, WIDTH, HEIGHT, PORT, PARAMS.  Use two dollar signs ($$) to
     get a dollar sign in the generated html. -->

<!DOCTYPE html>
<html>
<head>
  <!--
    This UI for noVNC is optimized to access the Graphical User Interface (GUI)
    of a single running application.  This is perfect for applications running
    inside a Docker container.

    Connect parameters are determined automatically.  However, they can, like
    all supported parameters, be overwritten with a query string:
        http://example.com/?host=HOST&port=PORT&encrypt=1&true_color=1
  -->

  <title>@NOVNC_TITLE</title>

  <meta charset="utf-8" />

  <!-- Always force latest IE rendering engine -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />

  <!-- Apple iOS - Hide Safari User Interface Components -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <!-- Apple iOS - Status Bar Appearance -->
  <!--<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />-->

  <!-- BEGIN Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="images/icons/apple-touch-icon.png?v=b1dae64d0f">
<link rel="icon" type="image/png" sizes="32x32" href="images/icons/favicon-32x32.png?v=b1dae64d0f">
<link rel="icon" type="image/png" sizes="16x16" href="images/icons/favicon-16x16.png?v=b1dae64d0f">
<link rel="manifest" href="images/icons/site.webmanifest?v=b1dae64d0f">
<link rel="mask-icon" href="images/icons/safari-pinned-tab.png?v=b1dae64d0f" color="#5bbad5">
<link rel="shortcut icon" href="images/icons/favicon.ico?v=b1dae64d0f">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="msapplication-config" content="images/icons/browserconfig.xml?v=b1dae64d0f">
<meta name="theme-color" content="#ffffff">
  <!-- END Favicons -->

  <!-- JQuery -->
  <script src="js/jquery.min.js?v=b80cd69e7d"></script>
  <script src="js/jquery-ui.custom.js?v=b80cd69e7d"></script>
  <script src="js/jquery.ui.touch-punch.min.js?v=b80cd69e7d"></script>

  <!-- Bootstrap JS -->
  <script src="js/bootstrap.min.js?v=b80cd69e7d"></script>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css?v=b80cd69e7d">
  <link rel="stylesheet" href="css/bootstrap.custom.css?v=b80cd69e7d">
  <link rel="stylesheet" href="css/font-awesome.min.css?v=b80cd69e7d">

  <!-- noVNC -->
  <script src="js/novnc-core.min.js?v=b80cd69e7d"></script>
  <script src="js/novnc-ui.min.js?v=b80cd69e7d"></script>
  <!-- i18n Support -->
  <script src="js/i18n.js?v=b80cd69e7d"></script>
  <script>
    // Monkey-patch the broken clipboard functions to correctly handle UTF-8.
    // This is a more robust fix that is not dependent on other files.
    function applyClipboardFix() {
        if (typeof RFB !== 'undefined') {
            console.log("Applying clipboard encoding fixes...");

            // 1. Fix receiving clipboard data (e.g., from server to browser)
            RFB.prototype._handle_server_cut_text = function () {
                Util.Debug(">> RFB.prototype._handle_server_cut_text (PATCHED)");
                if (this._sock.rQwait("ServerCutText header", 7, 1)) { return false; }
                this._sock.rQskipBytes(3);  // Padding
                var length = this._sock.rQshift32();
                if (this._sock.rQwait("ServerCutText", length, 8)) { return false; }

                var utf8Bytes = this._sock.rQshiftBytes(length);
                var text = '';

                try {
                    // Modern, correct way to decode UTF-8 using TextDecoder
                    var decoder = new TextDecoder('utf-8');
                    text = decoder.decode(utf8Bytes);
                    Util.Info("Clipboard text successfully decoded as UTF-8.");
                } catch (e) {
                    Util.Error("TextDecoder failed, attempting fallback: " + e);
                    try {
                        // Fallback for older browsers
                        var latin1String = '';
                        for (var i = 0; i < utf8Bytes.length; i++) {
                            latin1String += String.fromCharCode(utf8Bytes[i]);
                        }
                        text = decodeURIComponent(escape(latin1String));
                    } catch (e2) {
                         Util.Error("All clipboard decoding fallbacks failed: " + e2);
                         text = "CLIPBOARD DECODING FAILED";
                    }
                }

                this._onClipboard(this, text);
                return true;
            };

            // 2. Fix sending clipboard data (e.g., from browser to server)
            RFB.messages.clientCutText = function (sock, text) {
                Util.Debug(">> RFB.messages.clientCutText (PATCHED)");
                var buff = sock._sQ;
                var offset = sock._sQlen;

                buff[offset] = 6; // msg-type
                buff[offset + 1] = 0; // padding
                buff[offset + 2] = 0; // padding
                buff[offset + 3] = 0; // padding

                // Proper UTF-8 encoding for sending
                var utf8string = unescape(encodeURIComponent(text));
                var len = utf8string.length;

                buff[offset + 4] = (len >> 24) & 0xFF;
                buff[offset + 5] = (len >> 16) & 0xFF;
                buff[offset + 6] = (len >> 8) & 0xFF;
                buff[offset + 7] = (len) & 0xFF;

                sock._sQlen += 8;

                for (var i = 0; i < len; i++) {
                    buff[sock._sQlen++] = utf8string.charCodeAt(i);
                }
            };

            console.log("Clipboard encoding fixes applied.");
        } else {
            // Retry if RFB is not loaded yet
            setTimeout(applyClipboardFix, 100);
        }
    }

    applyClipboardFix();

    $(document).ready(function() {
      // Initialize i18n first
      I18n.init();
      // Start UI
      UI.start();

      // Re-apply language after UI starts to ensure all elements are translated
      setTimeout(function() {
        I18n.applyLanguage();
      }, 100);
    });
  </script>

</head>

<body>
  <!-- Fixed, transparent area at the top used to show the navbar when hidden. -->
  <!--<div id="topArea" style="top:0;position:fixed;height:2px;width:100%;background:none;"></div>-->

  <!-- Hidden textbox to trigger virtual keyboard and catch it inputs. -->
  <textarea style="width:1px;height:1px;background-color:#fff;color:#fff;border:0;position:absolute;left:-40px;z-index:-1;ime-mode: disabled;"
            id="virtualKeyboardInput" autocapitalize="off"
            autocorrect="off" autocomplete="off" spellcheck="false"
            mozactionhint="Enter"></textarea>

  <!-- Navigation bar -->
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
      <!-- App name and status icon -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <img class="img-responsive pull-left" style="height:40px;margin-top:6px;padding-right:10px;" src="images/icons/master_icon.png?v=b80cd69e7d" alt="@NOVNC_TITLE" />
        <div class="navbar-brand">
          <span id="appName">@NOVNC_TITLE</span>
          <span>&nbsp;</span>
          <i id="statusIcon" class="fa fa-spinner fa-spin fa-lg text-primary" data-toggle="tooltip" data-placement="bottom" data-i18n-title="status.connecting" aria-hidden="true"></i>
          <span id="statusIconSR" class="sr-only" data-i18n="status.connecting">正在连接...</span>
        </div>
      </div>
      <!-- Buttons -->
      <div class="collapse navbar-collapse" id="myNavbar">
        <ul class="nav navbar-nav navbar-right">
          <!-- Hideable navbar -->
          <li id="navbarHideableNavbarButton" class="hide">
            <button id="hideableNavbarToggleButton" class="btn btn-default navbar-btn" data-i18n-title="tooltip.hideable">
              <i class="fa fa-chevron-up fa-fw" aria-hidden="true"></i>
              <span class="hidden-sm" data-i18n="nav.hideable">&nbsp;可隐藏导航栏</span>
            </button>
          </li>
          <!-- Auto-hide navbar -->
          <li id="navbarDynamicNavbarButton" class="hide">
            <button id="dynamicNavbarToggleButton" class="btn btn-default navbar-btn" data-i18n-title="tooltip.autoHide">
              <i class="fa fa-chevron-up fa-fw" aria-hidden="true"></i>
              <span class="hidden-sm" data-i18n="nav.autoHide">&nbsp;自动隐藏</span>
            </button>
          </li>
          <!-- Fullscreen -->
          <li id="navbarFullscreenButton" class="hide">
            <button id="fullscreenToggleButton" class="btn btn-default navbar-btn" data-i18n-title="tooltip.fullscreen">
              <i class="fa fa-arrows-alt fa-fw" aria-hidden="true"></i>
              <span class="hidden-sm" data-i18n="nav.fullscreen">&nbsp;全屏</span>
            </button>
          </li>
          <!-- Auto scale -->
          <li id="navbarAutoScalingButton" class="hide">
            <button id="autoScalingToggleButton" class="btn btn-default navbar-btn" data-i18n-title="tooltip.autoScale">
              <i class="fa fa-expand fa-fw" aria-hidden="true"></i>
              <span class="hidden-sm" data-i18n="nav.autoScale">&nbsp;自动缩放</span>
            </button>
          </li>
          <!-- Clipboard -->
          <li id="navbarClipboardButton" class="hide">
            <button id="clipboardModalButton" class="btn btn-default navbar-btn" data-toggle="modal" data-target="#clipboardModal" data-i18n-title="tooltip.clipboard">
              <i class="fa fa-clipboard fa-fw" aria-hidden="true"></i>
              <span class="hidden-sm" data-i18n="nav.clipboard">&nbsp;剪贴板</span>
            </button>
          </li>
          <!-- Virtual keyboard -->
          <li id="navbarVirtualKeyboardButton" class="hide">
            <button id="virtualKeyboardToggleButton" class="btn btn-default navbar-btn" data-i18n-title="tooltip.keyboard">
              <i class="fa fa-keyboard-o fa-fw" aria-hidden="true"></i>
              <span class="hidden-sm" data-i18n="nav.keyboard">&nbsp;键盘</span>
            </button>
          </li>
          <!-- Language switcher -->
          <li id="navbarLanguageButton">
            <div class="btn-group">
              <button type="button" class="btn btn-default navbar-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-i18n-title="nav.language">
                <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                <span class="hidden-sm" id="currentLanguageText" data-i18n="lang.zh">中文</span>
                <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-right" id="languageDropdown">
                <li><a href="#" data-lang="zh-CN" class="language-option"><span data-i18n="lang.zh">中文</span> <i class="fa fa-check language-check" style="display:none;"></i></a></li>
                <li><a href="#" data-lang="en-US" class="language-option"><span data-i18n="lang.en">English</span> <i class="fa fa-check language-check" style="display:none;"></i></a></li>
              </ul>
            </div>
          </li>

        </ul>
      </div>
    </div>
  </nav>

  <!-- Navigation bar visibility toggle button -->
  <div id="navbarVisibilityToggleButton" class="hide" style="top:50px;position:fixed;margin-left:-26px;left:50%;cursor:pointer;" role="button" tabindex="0" data-i18n-title="nav.showHide">
   <i id="navbarVisibilityToggleButtonIcon" class="fa fa-border fa-chevron-up" aria-hidden="true" style="padding-left:20px;padding-right:20px;background-color:white;cursor:pointer;"></i>
  </div>

  <!--
    Canvas for the Remote Frame Buffer (RFB).
    The top margin is needed to make the canvas appear below the navbar.  This
    margin is removed when navbar is hideable.
  -->
  <canvas id="rfbScreen" class="center-block" style="margin-top:51px;" role="img" data-i18n-title="canvas.label">
    <p data-i18n="canvas.notSupported">您的浏览器不支持Canvas。请使用现代浏览器访问此应用程序。</p>
  </canvas>

  <!-- Password Modal -->
  <div class="modal fade" id="passwordModal" role="dialog" aria-labelledby="passwordModalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" data-i18n-title="modal.password.close">&times;</button>
          <h4 class="modal-title" id="passwordModalTitle" data-i18n="modal.password.title">需要密码</h4>
        </div>
        <div class="modal-body">
            <label for="vnc_password" class="sr-only" data-i18n="modal.password.placeholder">密码</label>
            <input type="password" class="form-control" id="vnc_password" name="password" data-i18n="modal.password.placeholder" data-i18n-attr="placeholder" autocomplete="current-password" autofocus/>
            <div class="checkbox" style="margin-top: 15px;">
              <label><input type="checkbox" id="remember_me" checked> <span data-i18n="modal.password.remember">记住我</span></label>
            </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="SubmitPasswordButton" data-i18n="modal.password.submit">提交</button>
          <button class="btn btn-default" data-dismiss="modal" data-i18n="modal.password.cancel">取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Clipboard Modal -->
  <div class="modal fade" id="clipboardModal" role="dialog" aria-labelledby="clipboardModalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" data-i18n-title="modal.clipboard.close">&times;</button>
          <h4 class="modal-title" id="clipboardModalTitle" data-i18n="modal.clipboard.title">剪贴板</h4>
        </div>
        <div class="modal-body">
          <p data-i18n="modal.clipboard.description">这是远程应用程序的剪贴板内容。</p>
          <label for="clipboard_content" class="sr-only" data-i18n="modal.clipboard.placeholder">剪贴板内容</label>
          <textarea rows="8" class="form-control" id="clipboard_content" data-i18n="modal.clipboard.placeholder" data-i18n-attr="placeholder"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="SubmitClipboardButton" data-i18n="modal.clipboard.submit">提交</button>
          <button class="btn btn-default" id="ClearClipboardButton" data-i18n="modal.clipboard.clear">清空</button>
          <button class="btn btn-default" data-dismiss="modal" data-i18n="modal.clipboard.close">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Language Switcher Script -->
  <script>
    $(document).ready(function() {
      // Language switcher functionality
      function updateLanguageIndicator() {
        var currentLang = I18n.getLanguage();
        var langText = currentLang === 'zh-CN' ? I18n.t('lang.zh') : I18n.t('lang.en');
        $('#currentLanguageText').text(langText);
        
        // Update checkmarks in dropdown
        $('.language-option').each(function() {
          var $option = $(this);
          var $check = $option.find('.language-check');
          if ($option.data('lang') === currentLang) {
            $check.show();
            $option.addClass('active');
          } else {
            $check.hide();
            $option.removeClass('active');
          }
        });
      }
      
      // Update dynamic elements that might change
      function updateDynamicElements() {
        // Update canvas aria-label
        var canvasLabel = I18n.t('canvas.label');
        $('#rfbScreen').attr('aria-label', canvasLabel);
        
        // Update status icon tooltip if it exists
        var $statusIcon = $('#statusIcon');
        if ($statusIcon.length && $statusIcon.attr('data-i18n-title')) {
          var statusKey = $statusIcon.attr('data-i18n-title');
          var statusText = I18n.t(statusKey);
          $statusIcon.attr('title', statusText);
          $statusIcon.attr('aria-label', statusText);
          
          // Update screen reader text
          $('#statusIconSR').text(statusText);
        }
      }
      
      // Handle language selection
      $('.language-option').on('click', function(e) {
        e.preventDefault();
        var lang = $(this).data('lang');
        if (I18n.setLanguage(lang)) {
          updateLanguageIndicator();
          updateDynamicElements();
          
          // Update tooltips - destroy and recreate to refresh text
          $('[data-toggle="tooltip"]').each(function() {
            var $el = $(this);
            $el.tooltip('destroy');
            if ($el.attr('data-i18n-title')) {
              var tooltipKey = $el.attr('data-i18n-title');
              $el.attr('title', I18n.t(tooltipKey));
              $el.attr('aria-label', I18n.t(tooltipKey));
            }
            $el.tooltip();
          });
        }
      });

      
      // Listen for language changes
      document.addEventListener('languageChanged', function(e) {
        updateLanguageIndicator();
        updateDynamicElements();
      });
      
      // Initial update
      updateLanguageIndicator();
      updateDynamicElements();
      
      // Expose update function for external use (e.g., when status changes)
      window.updateI18nStatus = function(statusKey) {
        if (statusKey) {
          $('#statusIcon').attr('data-i18n-title', statusKey);
          $('#statusIconSR').attr('data-i18n', statusKey);
        }
        updateDynamicElements();
        // Reapply i18n to update the text
        I18n.applyLanguage();
      };
    });
  </script>

</body>
</html>
